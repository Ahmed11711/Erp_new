<div class="container-fluid" dir="rtl">
  <div class="row" style="height: calc(100vh - 100px);">
    <!-- Customers List -->
    <div class="col-md-3 border-end" style="overflow-y: auto; max-height: 100%;">
      <div class="p-3 border-bottom">
        <h5>المحادثات</h5>
      </div>
      <div *ngIf="loading && !customerId" class="text-center p-3">
        <p>جاري التحميل...</p>
      </div>
      <div *ngFor="let customer of customers" 
           class="p-3 border-bottom cursor-pointer"
           [class.bg-light]="customerId === customer.id"
           (click)="selectCustomer(customer)"
           style="cursor: pointer;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>{{customer.name}}</strong>
            <br>
            <small class="text-muted">{{customer.phone}}</small>
            <br>
            <small class="text-muted" *ngIf="customer.messages_count > 0">
              {{customer.messages_count}} رسالة
            </small>
          </div>
          <button mat-icon-button (click)="openWhatsApp(customer); $event.stopPropagation()" 
                  matTooltip="فتح واتساب">
            <mat-icon>chat</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-9 d-flex flex-column" *ngIf="customerId && customer">
      <!-- Chat Header -->
      <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <div>
          <h5>{{customer.name}}</h5>
          <small class="text-muted">{{customer.phone}}</small>
        </div>
        <button mat-icon-button (click)="openWhatsApp(customer)" matTooltip="فتح واتساب">
          <mat-icon>open_in_new</mat-icon>
        </button>
      </div>

      <!-- Messages -->
      <div id="chat-messages" class="flex-grow-1 p-3" style="overflow-y: auto; background-color: #f5f5f5;">
        <div *ngIf="loading" class="text-center">
          <p>جاري التحميل...</p>
        </div>
        <div *ngFor="let message of messages" class="mb-3">
          <div [class.text-end]="message.direction === 'outbound'" 
               [class.text-start]="message.direction === 'inbound'">
            <div class="d-inline-block p-3 rounded" 
                 [class.bg-primary]="message.direction === 'outbound'"
                 [class.text-white]="message.direction === 'outbound'"
                 [class.bg-white]="message.direction === 'inbound'"
                 [class.border]="message.direction === 'inbound'"
                 style="max-width: 70%;">
              <p class="mb-1">{{message.content}}</p>
              <small [class.text-white-50]="message.direction === 'outbound'"
                     [class.text-muted]="message.direction === 'inbound'">
                {{formatDate(message.created_at)}}
                <span *ngIf="message.sender" class="ms-2">
                  - {{message.sender.name}}
                </span>
              </small>
            </div>
          </div>
        </div>
        <div *ngIf="messages.length === 0 && !loading" class="text-center text-muted">
          <p>لا توجد رسائل بعد</p>
        </div>
      </div>

      <!-- Message Input -->
      <div class="p-3 border-top bg-white">
        <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">
          <div class="d-flex">
            <input 
              type="text" 
              class="form-control me-2" 
              formControlName="message"
              placeholder="اكتب رسالة..."
              [disabled]="sending">
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="messageForm.invalid || sending">
              <span *ngIf="sending">جاري الإرسال...</span>
              <span *ngIf="!sending">إرسال</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- No Customer Selected -->
    <div class="col-md-9 d-flex align-items-center justify-content-center" *ngIf="!customerId">
      <div class="text-center text-muted">
        <mat-icon style="font-size: 64px; width: 64px; height: 64px;">chat</mat-icon>
        <p class="mt-3">اختر محادثة لعرض الرسائل</p>
      </div>
    </div>
  </div>
</div>

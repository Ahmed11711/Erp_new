<div class="container-fluid">
  <div class="row py-3">
    <div class="col-4 d-flex align-items-center">
      <app-time></app-time>
    </div>
    <div class="col-6">
      <div>
        <p class="title header w-80 m-1"> إضافة عميل محتمل </p>
      </div>
    </div>
    <div class="col-2 d-flex align-items-center justify-content-end">
      <!-- <app-time></app-time> -->
    </div>
  </div>

  <div class="container-fluid">
    <form class="text-start w-100 mt-2" [formGroup]="form" *ngIf="form" (ngSubmit)="submitform()">

      <!-- Basic Information Section -->
      <div class="form-section">
        <h5 class="section-title">المعلومات الأساسية</h5>
        <div class="row">
          <div class="col-md-3">
            <div class="input-group">
              <label class="input-label">الصناعة</label>
              <ng-autocomplete [data]="leadIndustry" [searchKeyword]="industry" placeholder="اختر الصناعة"
                (keyup)="industryKeyUp($event)" (selected)='industryChange($event)' (inputCleared)="resetIndustry()"
                [itemTemplate]="itemTemplates1" [notFoundTemplate]="notFoundTemplate1">
              </ng-autocomplete>
              <ng-template #itemTemplates1 let-item>
                <a [innerHTML]="item.name"></a>
              </ng-template>
              <ng-template #notFoundTemplate1 let-notFound>
                <div [innerHTML]="notFound"></div>
              </ng-template>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <label class="input-label">الدولة</label>
              <ng-autocomplete [data]="countries" [searchKeyword]="catword" placeholder="اختر الدولة"
                [initialValue]="initialCountry" (selected)='countryChange($event)' (inputCleared)="resetInp()"
                [itemTemplate]="itemTemplates" [notFoundTemplate]="notFoundTemplate">
              </ng-autocomplete>
              <ng-template #itemTemplates let-item>
                <a [innerHTML]="item.name"></a>
              </ng-template>
              <ng-template #notFoundTemplate let-notFound>
                <div [innerHTML]="notFound"></div>
              </ng-template>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <label class="input-label">الحالة</label>
              <select class="form-select"
                [class.is-valid]="form.get('lead_status_id')?.errors ==null && form.get('lead_status_id')?.touched"
                [class.is-invalid]="form.get('lead_status_id')?.errors !=null && form.get('lead_status_id')?.touched"
                formControlName='lead_status_id'>
                <option value="" disabled selected>اختر الحالة</option>
                <option [value]="status?.id" *ngFor="let status of leadStatuses">{{status?.name}}</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <label class="input-label"> التاريخ </label>
              <input [class.is-valid]="form.get('date')?.errors ==null && form.get('date')?.touched"
                [class.is-invalid]="form.get('date')?.errors !=null && form.get('date')?.touched" autocomplete="off"
                formControlName="date" class="form-control" type="date">
            </div>
          </div>
        </div>
      </div>

      <!-- Company Information Section -->
      <div class="form-section company-info">
        <h5 class="section-title">معلومات الشركة</h5>
        <div class="row">
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">اسم الشركة *</label>
              <input autocomplete="off" class="form-control" placeholder="أدخل اسم الشركة"
                [class.is-valid]="form.get('company_name')?.errors ==null && form.get('company_name')?.touched"
                [class.is-invalid]="form.get('company_name')?.errors !=null && form.get('company_name')?.touched"
                formControlName='company_name' type="text">
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">المنصب</label>
              <input autocomplete="off" class="form-control" placeholder="المنصب (CEO، مدير، إلخ)"
                [class.is-valid]="form.get('contact_title')?.errors ==null && form.get('contact_title')?.touched"
                [class.is-invalid]="form.get('contact_title')?.errors !=null && form.get('contact_title')?.touched"
                formControlName='contact_title' type="text">
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">القسم</label>
              <input autocomplete="off" class="form-control" placeholder="القسم (تقنية المعلومات، المبيعات، إلخ)"
                [class.is-valid]="form.get('contact_department')?.errors ==null && form.get('contact_department')?.touched"
                [class.is-invalid]="form.get('contact_department')?.errors !=null && form.get('contact_department')?.touched"
                formControlName='contact_department' type="text">
            </div>
          </div>
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="form-section">
        <h5 class="section-title">معلومات جهة الاتصال</h5>
        <div formArrayName="contacts">
          <div class="contact-section" *ngFor="let contactGroup of contacts.controls; let i = index" [formGroupName]="i">
            <div class="contact-header">
              <h6 class="contact-title">جهة الاتصال #{{i + 1}}</h6>
              <button type="button" class="btn btn-remove" *ngIf="i > 0" (click)="removeContact(i)">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
            <div class="row">
               <div class="col-md-6">
                <div class="input-group">
                  <label class="input-label">اسم جهة الاتصال *</label>
                  <input autocomplete="off" class="form-control" placeholder="أدخل اسم جهة الاتصال"
                    [class.is-valid]="contactGroup.get('contact_name')?.errors ==null && contactGroup.get('contact_name')?.touched"
                    [class.is-invalid]="contactGroup.get('contact_name')?.errors !=null && contactGroup.get('contact_name')?.touched"
                    formControlName='contact_name' type="text">
                </div>
              </div> 
             <!-- <div class="col-md-6">
                <div class="input-group">
                  <label class="input-label">المنصب</label>
                  <input autocomplete="off" class="form-control" placeholder="المنصب (CEO، مدير، إلخ)"
                    [class.is-valid]="contactGroup.get('contact_title')?.errors ==null && contactGroup.get('contact_title')?.touched"
                    [class.is-invalid]="contactGroup.get('contact_title')?.errors !=null && contactGroup.get('contact_title')?.touched"
                    formControlName='contact_title' type="text">
                </div>
              </div> -->
            <!-- </div> 
            <div class="row"> -->
              <!-- <div class="col-md-6">
                <div class="input-group">
                  <label class="input-label">القسم</label>
                  <input autocomplete="off" class="form-control" placeholder="القسم (تقنية المعلومات، المبيعات، إلخ)"
                    [class.is-valid]="contactGroup.get('contact_department')?.errors ==null && contactGroup.get('contact_department')?.touched"
                    [class.is-invalid]="contactGroup.get('contact_department')?.errors !=null && contactGroup.get('contact_department')?.touched"
                    formControlName='contact_department' type="text">
                </div>
              </div> -->
              <div class="col-md-6">
                <div class="input-group">
                  <label class="input-label">رابط LinkedIn</label>
                  <input autocomplete="off" class="form-control" placeholder="رابط الملف الشخصي"
                    [class.is-valid]="contactGroup.get('contact_linkedin')?.errors ==null && contactGroup.get('contact_linkedin')?.touched"
                    [class.is-invalid]="contactGroup.get('contact_linkedin')?.errors !=null && contactGroup.get('contact_linkedin')?.touched"
                    formControlName='contact_linkedin' type="text">
                </div>
              </div>
            </div>
            
            <!-- Phones and Emails Section -->
            <div class="row mt-3">
              <div class="col-md-6">
                <h6 class="contact-title">أرقام الهاتف</h6>
                <div formArrayName="phones">
                  <div class="phone-group" *ngFor="let phoneGroup of getPhones(i).controls; let j = index" [formGroupName]="j">
                    <select class="form-select phone-select" formControlName="dial_code">
                      <option [value]="elm.dial_code" *ngFor="let elm of countries" [selected]="elm.name === 'Egypt'">{{elm.dial_code}}</option>
                    </select>
                    <input autocomplete="off" class="form-control phone-input" placeholder="رقم الهاتف"
                      [class.is-valid]="phoneGroup.get('contact_number')?.errors ==null && phoneGroup.get('contact_number')?.touched"
                      [class.is-invalid]="phoneGroup.get('contact_number')?.errors !=null && phoneGroup.get('contact_number')?.touched"
                      formControlName='contact_number' type="text">
                    <button type="button" class="btn btn-remove" *ngIf="j > 0" (click)="removePhone(i,j)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                  <button type="button" class="btn btn-add-item" (click)="addPhone(i)">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="contact-title">البريد الإلكتروني</h6>
                <div formArrayName="emails">
                  <div class="email-group" *ngFor="let emailCtrl of getEmails(i).controls; let j = index">
                    <input autocomplete="off" class="form-control email-input" placeholder="البريد الإلكتروني"
                      [class.is-valid]="emailCtrl.valid && emailCtrl.touched"
                      [class.is-invalid]="emailCtrl.invalid && emailCtrl.touched" [formControlName]='j' type="text">
                    <button type="button" class="btn btn-remove" *ngIf="j > 0" (click)="removeEmail(i,j)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                  <button type="button" class="btn btn-add-item" (click)="addEmail(i)">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="text-center mt-3">
          <button type="button" class="btn btn-add-contact" (click)="addContact()">
            <i class="fa-solid fa-plus mr-2"></i>
            إضافة جهة اتصال جديدة
          </button>
        </div>
      </div>

      <!-- Lead Source and Tools Section -->
      <div class="form-section">
        <h5 class="section-title">مصدر العميل المحتمل</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="input-group">
              <label class="input-label">المصدر</label>
              <div class="d-flex align-items-center">
                <select class="form-select"
                  [class.is-valid]="form.get('lead_source')?.errors ==null && form.get('lead_source')?.touched"
                  [class.is-invalid]="form.get('lead_source')?.errors !=null && form.get('lead_source')?.touched"
                  formControlName='lead_source'>
                  <option value="0" disabled selected>اختر المصدر</option>
                  <option [value]="elm?.id" *ngFor="let elm of leadSource">{{elm?.name}}</option>
                </select>
                <button type="button" class="btn btn-add-item" (click)="addSource()">
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <label class="input-label">الأداة</label>
              <div class="d-flex align-items-center">
                <select class="form-select"
                  [class.is-valid]="form.get('lead_tool')?.errors ==null && form.get('lead_tool')?.touched"
                  [class.is-invalid]="form.get('lead_tool')?.errors !=null && form.get('lead_tool')?.touched"
                  formControlName='lead_tool'>
                  <option value="0" disabled selected>اختر الأداة</option>
                  <option [value]="elm?.id" *ngFor="let elm of leadTools">{{elm?.name}}</option>
                </select>
                <button type="button" class="btn btn-add-item" (click)="addTool()">
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Social Media Links Section -->
      <div class="form-section">
        <h5 class="section-title">روابط التواصل الاجتماعي</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="social-input">
              <div class="input-group">
                <label class="input-label">LinkedIn</label>
                <input autocomplete="off" class="form-control" placeholder="رابط حساب الشركة"
                  [class.is-valid]="form.get('company_linkedin')?.errors ==null && form.get('company_linkedin')?.touched"
                  [class.is-invalid]="form.get('company_linkedin')?.errors !=null && form.get('company_linkedin')?.touched"
                  formControlName='company_linkedin' type="text">
              </div>
            </div>
            <div class="social-input">
              <div class="input-group">
                <label class="input-label">Facebook</label>
                <input autocomplete="off" class="form-control" placeholder="رابط حساب الشركة"
                  [class.is-valid]="form.get('company_facebook')?.errors ==null && form.get('company_facebook')?.touched"
                  [class.is-invalid]="form.get('company_facebook')?.errors !=null && form.get('company_facebook')?.touched"
                  formControlName='company_facebook' type="text">
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="social-input">
              <div class="input-group">
                <label class="input-label">Instagram</label>
                <input autocomplete="off" class="form-control" placeholder="رابط حساب الشركة"
                  [class.is-valid]="form.get('company_instagram')?.errors ==null && form.get('company_instagram')?.touched"
                  [class.is-invalid]="form.get('company_instagram')?.errors !=null && form.get('company_instagram')?.touched"
                  formControlName='company_instagram' type="text">
              </div>
            </div>
            <div class="social-input">
              <div class="input-group">
                <label class="input-label">الموقع الإلكتروني</label>
                <input autocomplete="off" class="form-control" placeholder="رابط الموقع الرسمي"
                  [class.is-valid]="form.get('company_website')?.errors ==null && form.get('company_website')?.touched"
                  [class.is-invalid]="form.get('company_website')?.errors !=null && form.get('company_website')?.touched"
                  formControlName='company_website' type="text">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes Section -->
      <div class="form-section">
        <h5 class="section-title">ملاحظات إضافية</h5>
        <div class="row">
          <div class="col-12">
            <div class="input-group">
              <label class="input-label">ملاحظات</label>
              <textarea class="form-control" placeholder="أضف أي ملاحظات إضافية عن العميل المحتمل" 
                formControlName='notes' rows="4"
                [class.is-valid]="form.get('notes')?.errors ==null && form.get('notes')?.touched"
                [class.is-invalid]="form.get('notes')?.errors !=null && form.get('notes')?.touched"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Details Section -->
      <!-- <div class="form-section">
        <h5 class="section-title">تفاصيل إضافية</h5>
        <div class="row">
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">حجم الشركة</label>
              <select class="form-select" formControlName="company_size">
                <option value="">اختر حجم الشركة</option>
                <option value="1-10">1-10 موظف</option>
                <option value="11-50">11-50 موظف</option>
                <option value="51-200">51-200 موظف</option>
                <option value="201-500">201-500 موظف</option>
                <option value="500+">أكثر من 500 موظف</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">الإيرادات السنوية</label>
              <select class="form-select" formControlName="annual_revenue">
                <option value="">اختر نطاق الإيرادات</option>
                <option value="less-1m">أقل من 1 مليون</option>
                <option value="1m-5m">1-5 مليون</option>
                <option value="5m-10m">5-10 مليون</option>
                <option value="10m-50m">10-50 مليون</option>
                <option value="50m+">أكثر من 50 مليون</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">القطاع الصناعي</label>
              <select class="form-select" formControlName="industry_sector">
                <option value="">اختر القطاع</option>
                <option value="technology">التقنية</option>
                <option value="healthcare">الرعاية الصحية</option>
                <option value="finance">التمويل</option>
                <option value="retail">التجزئة</option>
                <option value="manufacturing">التصنيع</option>
                <option value="education">التعليم</option>
                <option value="government">حكومي</option>
                <option value="other">أخرى</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">المنطقة الجغرافية</label>
              <input autocomplete="off" class="form-control" placeholder="مثال: الشرق الأوسط، شمال أفريقيا"
                formControlName='geographic_region' type="text">
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">المنافسون الرئيسيون</label>
              <input autocomplete="off" class="form-control" placeholder="أدخل أسماء المنافسين الرئيسيين"
                formControlName='main_competitors' type="text">
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label class="input-label">أولوية العميل</label>
              <select class="form-select" formControlName="lead_priority">
                <option value="">اختر الأولوية</option>
                <option value="high">عالية</option>
                <option value="medium">متوسطة</option>
                <option value="low">منخفضة</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="input-group">
              <label class="input-label">المنتجات/الخدمات المطلوبة</label>
              <textarea class="form-control" placeholder="صف المنتجات أو الخدمات التي يهتم بها العميل"
                formControlName='required_products' rows="3"></textarea>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <label class="input-label">الميزانية المتوقعة</label>
              <input autocomplete="off" class="form-control" placeholder="مثال: 100,000 - 500,000 ريال"
                formControlName='expected_budget' type="text">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="input-group">
              <label class="input-label">الإطار الزمني للمشروع</label>
              <select class="form-select" formControlName="project_timeline">
                <option value="">اختر الإطار الزمني</option>
                <option value="immediate">فوري</option>
                <option value="1-3-months">1-3 أشهر</option>
                <option value="3-6-months">3-6 أشهر</option>
                <option value="6-12-months">6-12 شهر</option>
                <option value="more-than-year">أكثر من عام</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <label class="input-label">صانع القرار</label>
              <select class="form-select" formControlName="decision_maker">
                <option value="">هل هو صانع قرار؟</option>
                <option value="yes">نعم</option>
                <option value="no">لا</option>
                <option value="influencer">مؤثر على القرار</option>
              </select>
            </div>
          </div>
        </div>
      </div> -->

      <!-- Next Action Section - Shows when Follow-Up status is selected -->
      <div class="row" *ngIf="form.get('lead_status_id')?.value && getSelectedStatus()?.requires_follow_up">
        <div class="col-12">
          <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0">
                <i class="fa-solid fa-clock me-2"></i>الإجراء التالي مطلوب
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="mb-3">
                    <label class="form-label">نوع الإجراء</label>
                    <select class="form-control form-select" formControlName="next_action_type">
                      <option value="">اختر الإجراء</option>
                      <option value="Call">مكالمة</option>
                      <option value="Email">بريد إلكتروني</option>
                      <option value="Meeting">اجتماع</option>
                      <option value="Follow-up Call">مكالمة متابعة</option>
                      <option value="Send Proposal">إرسال عرض</option>
                      <option value="Site Visit">زيارة الموقع</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <label class="form-label">تاريخ الإجراء</label>
                    <input type="date" class="form-control" formControlName="next_action_date">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">ملاحظات الإجراء</label>
                    <textarea class="form-control" placeholder="مثال: مكالمة لمناقشة تفاصيل العرض" 
                           formControlName="next_action_notes" rows="3"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-submit">إضافة عميل محتمل</button>
      </div>

    </form>
  </div>